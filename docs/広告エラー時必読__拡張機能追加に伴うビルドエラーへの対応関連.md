# 広告エラー時必読：拡張機能追加に伴うビルドエラーへの対応関連

**作成日**: 2025-11-23
**対応日**: 2025-11-23
**関連機能**: Share Extension実装、Google Mobile Ads

---

## 📋 概要

Share Extension（共有機能）を追加した際、Xcodeビルド時に循環依存エラーが発生。
`[CP-User] [RNGoogleMobileAds] Configuration` スクリプトを削除することで解決したが、
広告機能への影響の可能性があるため、詳細を記録する。

---

## 🔴 発生したエラー

### エラー内容
```
error: Cycle inside TextCast; building could produce unreliable results.
Cycle details:
→ Target 'TextCast' has copy command from 'TextCastShare.appex' to 'TextCast.app/PlugIns/TextCastShare.appex'
○ That command depends on command in Target 'TextCast': script phase "[CP-User] [RNGoogleMobileAds] Configuration"
○ Target 'TextCast' has process command with output 'TextCast.app/Info.plist'
○ Target 'TextCast' has copy command from 'TextCastShare.appex'...
```

### エラーの意味
**循環依存（Dependency Cycle）**: ビルド処理が無限ループする状態

---

## 🔍 エラーの根本原因

### 依存関係の循環

```
1. Share Extensionのコピー
   ↓ 依存
2. [RNGoogleMobileAds] Configurationスクリプト
   ↓ Input Files: $(BUILT_PRODUCTS_DIR)/$(INFOPLIST_PATH)
3. Info.plistの処理
   ↓ 依存
4. Share Extensionのコピー ← ループ！
```

### 技術的詳細

1. **Share Extension (TextCastShare.appex)** をメインアプリにコピーする処理
2. **[RNGoogleMobileAds] Configuration** スクリプトが `Input Files` に `Info.plist` を指定
3. Xcodeがこれを「Info.plistが完成するまで待つ」と解釈
4. しかしInfo.plist処理自体がShare Extensionのコピーを待っている
5. **結果**: 循環依存でビルド失敗

---

## 🛠 試した対応策

### ❌ 失敗した対応

1. **Input Filesの削除**
   - 結果: スクリプトがInfo.plistを見つけられずエラー
   - 理由: スクリプトがパスに依存していた

2. **"Based on dependency analysis" を有効化**
   - 結果: 効果なし
   - 理由: 最初から有効化されていた

3. **スクリプトに `exit 0` を追加**
   - 結果: 循環依存エラーは継続
   - 理由: Input Filesの依存関係宣言が問題だった

4. **Build Phasesの順序変更**
   - 結果: 効果なし
   - 理由: 根本的な循環構造は変わらない

---

## ✅ 最終的な解決策

### 対応内容
**`[CP-User] [RNGoogleMobileAds] Configuration` スクリプトを削除**

### 手順
1. Xcode → TARGETS → TextCast → Build Phases
2. `[CP-User] [RNGoogleMobileAds] Configuration` セクションを削除
3. ビルド成功

### ファイル変更
- **変更箇所**: `ios/TextCast.xcodeproj/project.pbxproj`
- **変更内容**: Build Phasesから該当スクリプトを削除

---

## 📊 削除したスクリプトの役割

### スクリプトの目的
**app.jsonの広告設定をInfo.plistに注入する**

具体的には：
```bash
# app.jsonから広告IDを読み取り
# Info.plistに GADApplicationIdentifier を書き込む
```

### なぜ削除しても問題ない可能性が高いか

#### 理由1: Expoの自動設定
`app.json` に以下の設定が存在：
```json
{
  "plugins": [
    [
      "react-native-google-mobile-ads",
      {
        "iosAppId": "ca-app-pub-3940256099942544~1458002511"
      }
    ]
  ]
}
```

**Expoは `npx expo prebuild` 時に自動的にこれをInfo.plistに反映**

#### 理由2: スクリプトの冗長性
- Expoが既にInfo.plistに設定を書き込んでいる
- このスクリプトは同じことを重複して行っていた
- つまり、**削除しても機能的には問題ない**はず

---

## ⚠️ 潜在的なリスクと確認事項

### リスク1: 広告が表示されない可能性

**可能性**: 低いが、ゼロではない

**理由**:
- Expoの自動設定が何らかの理由で失敗している場合
- react-native-google-mobile-adsの特定バージョンがスクリプトを要求する場合

### リスク2: 本番ビルド時の問題

**可能性**: 低い

**理由**:
- 開発ビルドとArchiveビルドで動作が異なる場合がある
- ただし、Info.plistの設定は共通なので影響は小さい

---

## ✅ 必須の確認事項（対応後）

### 1. 開発環境での確認
- [ ] シミュレーターでアプリを起動
- [ ] バナー広告が表示されることを確認
- [ ] インタースティシャル広告が表示されることを確認
- [ ] Xcodeのコンソールで広告関連のエラーがないか確認

### 2. Info.plistの確認
```bash
# Info.plistを確認
cat ios/TextCast/Info.plist | grep -A 2 "GADApplicationIdentifier"
```

**期待される出力**:
```xml
<key>GADApplicationIdentifier</key>
<string>ca-app-pub-3940256099942544~1458002511</string>
```

### 3. 本番ビルドでの確認（EAS Build）
- [ ] `eas build --platform ios --profile preview` を実行
- [ ] ビルドが成功することを確認
- [ ] TestFlightで配信してテスト
- [ ] 広告が正常に表示されることを確認

---

## 🔄 もし広告が表示されない場合の対応

### ステップ1: Info.plistの確認
上記の確認事項2を実施。`GADApplicationIdentifier` が存在しない場合：

```bash
# 手動でInfo.plistに追加
# ios/TextCast/Info.plist に以下を追加：
<key>GADApplicationIdentifier</key>
<string>ca-app-pub-3940256099942544~1458002511</string>
```

### ステップ2: スクリプトを別の方法で実装

**循環依存を回避しつつスクリプトを有効化する方法**:

#### 方法A: Input Filesを削除してスクリプトを修正

1. スクリプトを再追加
2. **Input Filesは空のまま**
3. スクリプト内でInfo.plistパスを動的に検索：

```bash
#!/bin/sh

# Info.plistを動的に検索（Input Files不要）
PLIST_PATH="${TARGET_BUILD_DIR}/${INFOPLIST_PATH}"

if [ ! -f "$PLIST_PATH" ]; then
    echo "warning: Info.plist not found at $PLIST_PATH"
    exit 0
fi

# 以下、既存の処理...
```

#### 方法B: Podfileを修正してスクリプトを無効化

`ios/Podfile` に以下を追加：

```ruby
post_install do |installer|
  installer.pods_project.targets.each do |target|
    if target.name == 'RNGoogleMobileAds'
      # ビルドスクリプトを無効化
      target.build_phases.each do |phase|
        if phase.respond_to?(:name) && phase.name == '[CP-User] [RNGoogleMobileAds] Configuration'
          phase.remove_from_project
        end
      end
    end
  end
end
```

その後：
```bash
cd ios && pod install
```

---

## 📝 技術的補足

### CocoaPods（CP）のユーザースクリプトとは

- `[CP-User]` プレフィックスは**CocoaPods管理下のカスタムスクリプト**
- `Podfile` の `post_install` フックや、Podspec内で定義される
- `pod install` 時に自動生成される

### Expo Prebuildの仕組み

1. `app.json` を読み取り
2. ネイティブプロジェクト（ios/android）を生成
3. プラグインの設定をInfo.plist/AndroidManifest.xmlに反映
4. CocoaPodsを実行（`pod install`）

### Share Extensionとビルド依存関係

- Share ExtensionはメインアプリにEmbedされる（`PlugIns/`フォルダに配置）
- Embedフェーズは通常Build Phasesの最後に実行される
- 他のフェーズがEmbedフェーズに依存すると循環が発生しやすい

---

## 🎯 結論

### 現状の評価

✅ **スクリプト削除は妥当な判断**
- Expoの自動設定で広告IDは設定済み
- スクリプトは冗長だった可能性が高い

⚠️ **ただし確認は必須**
- 実際に広告が表示されるかテストが必要
- 本番ビルドでも確認すること

### 今後の方針

1. **まず動作確認**（上記の「必須の確認事項」を実施）
2. **広告が表示される** → 問題なし、このまま運用
3. **広告が表示されない** → 「もし広告が表示されない場合の対応」を実施

---

## 📚 参考リンク

- [React Native Google Mobile Ads 公式ドキュメント](https://docs.page/invertase/react-native-google-mobile-ads)
- [Expo Plugins - AdMob](https://docs.expo.dev/versions/latest/sdk/admob/)
- [Xcode Build System - Dependency Cycles](https://developer.apple.com/documentation/xcode/build-system)
- [CocoaPods Hooks](https://guides.cocoapods.org/syntax/podfile.html#hooks)

---

## 変更履歴

| 日付 | 対応者 | 内容 |
|------|--------|------|
| 2025-11-23 | Claude | Share Extension追加に伴う循環依存エラーへの対応 |
| 2025-11-23 | Claude | `[CP-User] [RNGoogleMobileAds] Configuration` スクリプトを削除 |
